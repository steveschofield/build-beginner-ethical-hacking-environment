---
- name: Deploy Vulnerable Applications for Ethical Hacking Practice
  hosts: 127.0.0.1
  connection: local
  become: yes
  gather_facts: true
  vars:
    groupname: 52pickup
    username: 52pickup
    code_dir: "/home/{{ username }}/code"
    scripts_dir: "/home/{{ username }}/scripts"

  tasks:
    # ===========================================
    # Directory Setup
    # ===========================================
    - name: Ensure code directory exists
      ansible.builtin.file:
        path: "{{ code_dir }}"
        state: directory
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0755"

    - name: Ensure scripts directory exists
      ansible.builtin.file:
        path: "{{ scripts_dir }}"
        state: directory
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0755"

    # ===========================================
    # Pull Docker Images
    # ===========================================
    - name: Pull Juice Shop image
      community.docker.docker_image:
        name: bkimminich/juice-shop
        source: pull

    - name: Pull WebGoat image
      community.docker.docker_image:
        name: webgoat/webgoat
        source: pull

    - name: Pull VAmPI image
      community.docker.docker_image:
        name: erev0s/vampi
        source: pull
        tag: latest

    - name: Pull WrongSecrets image
      community.docker.docker_image:
        name: jeroenwillemsen/wrongsecrets
        source: pull
        tag: latest-no-vault

    - name: Pull OWASP Security Shepherd image
      community.docker.docker_image:
        name: owasp/security-shepherd
        source: pull

    - name: Pull NodeGoat image
      community.docker.docker_image:
        name: nodegoat/nodegoat
        source: pull

    # ===========================================
    # Build Local Images (DVWA, Musashi, Vuln-Bank)
    # ===========================================
    - name: Clone DVWA repository
      ansible.builtin.git:
        repo: https://github.com/digininja/dvwa
        dest: "{{ code_dir }}/dvwa"
        force: yes
      become_user: "{{ username }}"

    - name: Update DVWA compose.yml to bind to all interfaces
      ansible.builtin.replace:
        path: "{{ code_dir }}/dvwa/compose.yml"
        regexp: '127\.0\.0\.1:4280:80'
        replace: '0.0.0.0:4280:80'

    - name: Build DVWA Docker image
      community.docker.docker_image:
        name: dvwa
        source: build
        build:
          path: "{{ code_dir }}/dvwa"
        force_source: yes

    - name: Clone Musashi-js repository
      ansible.builtin.git:
        repo: https://github.com/SamuraiWTF/musashi-js
        dest: "{{ code_dir }}/musashi-js"
        force: yes
      become_user: "{{ username }}"

    - name: Build Musashi-js Docker image
      community.docker.docker_image:
        name: musashi-js
        source: build
        build:
          path: "{{ code_dir }}/musashi-js"
        force_source: yes

    - name: Clone Vuln-Bank repository
      ansible.builtin.git:
        repo: https://github.com/Commando-X/vuln-bank
        dest: "{{ code_dir }}/vuln-bank"
        force: yes
      become_user: "{{ username }}"

    - name: Build Vuln-Bank Docker image
      community.docker.docker_image:
        name: vuln-bank
        source: build
        build:
          path: "{{ code_dir }}/vuln-bank"
        force_source: yes

    # ===========================================
    # Start Vulnerable Application Containers
    # ===========================================
    - name: Start Juice Shop container
      community.docker.docker_container:
        name: juice-shop
        image: bkimminich/juice-shop
        state: started
        restart_policy: unless-stopped
        ports:
          - "3000:3000"

    - name: Start WebGoat container
      community.docker.docker_container:
        name: webgoat
        image: webgoat/webgoat
        state: started
        restart_policy: unless-stopped
        ports:
          - "8080:8080"
          - "9090:9090"

    - name: Start VAmPI container
      community.docker.docker_container:
        name: vampi
        image: erev0s/vampi:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "5000:5000"

    - name: Start WrongSecrets container
      community.docker.docker_container:
        name: wrongsecrets
        image: jeroenwillemsen/wrongsecrets:latest-no-vault
        state: started
        restart_policy: unless-stopped
        ports:
          - "8081:8080"

    - name: Start DVWA container
      community.docker.docker_container:
        name: dvwa
        image: dvwa
        state: started
        restart_policy: unless-stopped
        ports:
          - "4280:80"

    - name: Start Musashi-js container
      community.docker.docker_container:
        name: musashi-js
        image: musashi-js
        state: started
        restart_policy: unless-stopped
        ports:
          - "8082:8220"

    - name: Start Vuln-Bank container
      community.docker.docker_container:
        name: vuln-bank
        image: vuln-bank
        state: started
        restart_policy: unless-stopped
        ports:
          - "5001:5000"

    - name: Start Security Shepherd container
      community.docker.docker_container:
        name: security-shepherd
        image: owasp/security-shepherd
        state: started
        restart_policy: unless-stopped
        ports:
          - "8083:80"

    - name: Start NodeGoat container
      community.docker.docker_container:
        name: nodegoat
        image: nodegoat/nodegoat
        state: started
        restart_policy: unless-stopped
        ports:
          - "4000:4000"

    # ===========================================
    # Create vuln-apps helper script
    # ===========================================
    - name: Create vuln-apps helper script
      ansible.builtin.copy:
        dest: /usr/local/bin/vuln-apps
        mode: "0755"
        content: |
          #!/bin/bash
          # Vulnerable Apps Management Script
          # Usage: vuln-apps [start|stop|restart|status|list|logs]

          APPS=(
              "juice-shop:3000:OWASP Juice Shop - Modern web app security"
              "webgoat:8080:WebGoat - Security lessons platform"
              "vampi:5000:VAmPI - Vulnerable API (OWASP Top 10)"
              "wrongsecrets:8081:WrongSecrets - Secrets management challenges"
              "dvwa:4280:DVWA - Damn Vulnerable Web Application"
              "musashi-js:8082:Musashi-js - JavaScript security challenges"
              "vuln-bank:5001:Vuln-Bank - Banking vulnerabilities"
              "security-shepherd:8083:Security Shepherd - Guided security tutorials"
              "nodegoat:4000:NodeGoat - Node.js OWASP Top 10"
          )

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color

          get_ip() {
              hostname -I | awk '{print $1}'
          }

          show_list() {
              IP=$(get_ip)
              echo -e "\n${BLUE}=== Vulnerable Applications ===${NC}\n"
              printf "%-20s %-8s %s\n" "NAME" "PORT" "DESCRIPTION"
              printf "%-20s %-8s %s\n" "----" "----" "-----------"
              for app in "${APPS[@]}"; do
                  IFS=':' read -r name port desc <<< "$app"
                  printf "%-20s %-8s %s\n" "$name" "$port" "$desc"
              done
              echo -e "\n${YELLOW}Access apps at: http://${IP}:<PORT>${NC}\n"
          }

          show_status() {
              IP=$(get_ip)
              echo -e "\n${BLUE}=== Application Status ===${NC}\n"
              printf "%-20s %-10s %-8s %s\n" "NAME" "STATUS" "PORT" "URL"
              printf "%-20s %-10s %-8s %s\n" "----" "------" "----" "---"
              for app in "${APPS[@]}"; do
                  IFS=':' read -r name port desc <<< "$app"
                  if docker ps --format '{{.Names}}' | grep -q "^${name}$"; then
                      status="${GREEN}Running${NC}"
                      url="http://${IP}:${port}"
                  else
                      status="${RED}Stopped${NC}"
                      url="-"
                  fi
                  printf "%-20s %-10b %-8s %s\n" "$name" "$status" "$port" "$url"
              done
              echo ""
          }

          start_apps() {
              echo -e "${BLUE}Starting all vulnerable applications...${NC}"
              for app in "${APPS[@]}"; do
                  IFS=':' read -r name port desc <<< "$app"
                  if docker ps --format '{{.Names}}' | grep -q "^${name}$"; then
                      echo -e "  ${YELLOW}$name${NC} - already running"
                  else
                      docker start "$name" 2>/dev/null && \
                          echo -e "  ${GREEN}$name${NC} - started" || \
                          echo -e "  ${RED}$name${NC} - failed to start"
                  fi
              done
              echo -e "\n${GREEN}Done!${NC} Run 'vuln-apps status' to see URLs."
          }

          stop_apps() {
              echo -e "${BLUE}Stopping all vulnerable applications...${NC}"
              for app in "${APPS[@]}"; do
                  IFS=':' read -r name port desc <<< "$app"
                  if docker ps --format '{{.Names}}' | grep -q "^${name}$"; then
                      docker stop "$name" 2>/dev/null && \
                          echo -e "  ${YELLOW}$name${NC} - stopped" || \
                          echo -e "  ${RED}$name${NC} - failed to stop"
                  else
                      echo -e "  ${YELLOW}$name${NC} - not running"
                  fi
              done
              echo -e "\n${GREEN}Done!${NC}"
          }

          restart_apps() {
              stop_apps
              echo ""
              start_apps
          }

          show_logs() {
              if [ -z "$2" ]; then
                  echo "Usage: vuln-apps logs <app-name>"
                  echo "Available apps:"
                  for app in "${APPS[@]}"; do
                      IFS=':' read -r name port desc <<< "$app"
                      echo "  - $name"
                  done
                  exit 1
              fi
              docker logs -f "$2"
          }

          show_help() {
              echo -e "\n${BLUE}Vulnerable Apps Management Script${NC}"
              echo -e "\nUsage: vuln-apps <command> [options]\n"
              echo "Commands:"
              echo "  list      Show all available applications with ports"
              echo "  status    Show running status and URLs for all apps"
              echo "  start     Start all vulnerable applications"
              echo "  stop      Stop all vulnerable applications"
              echo "  restart   Restart all vulnerable applications"
              echo "  logs      Show logs for a specific app (vuln-apps logs <app-name>)"
              echo "  help      Show this help message"
              echo ""
          }

          case "${1:-help}" in
              list)    show_list ;;
              status)  show_status ;;
              start)   start_apps ;;
              stop)    stop_apps ;;
              restart) restart_apps ;;
              logs)    show_logs "$@" ;;
              help|*)  show_help ;;
          esac

    # ===========================================
    # Create Landing Page
    # ===========================================
    - name: Create landing page directory
      ansible.builtin.file:
        path: /var/www/html
        state: directory
        mode: "0755"

    - name: Create landing page HTML
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        mode: "0644"
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Ethical Hacking Lab</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                      min-height: 100vh;
                      color: #eee;
                      padding: 20px;
                  }
                  .container { max-width: 1200px; margin: 0 auto; }
                  h1 {
                      text-align: center;
                      margin-bottom: 10px;
                      color: #00d4ff;
                      text-shadow: 0 0 10px rgba(0,212,255,0.5);
                  }
                  .subtitle {
                      text-align: center;
                      color: #888;
                      margin-bottom: 30px;
                  }
                  .warning {
                      background: #ff6b6b22;
                      border: 1px solid #ff6b6b;
                      border-radius: 8px;
                      padding: 15px;
                      margin-bottom: 30px;
                      text-align: center;
                  }
                  .warning strong { color: #ff6b6b; }
                  .apps-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                      gap: 20px;
                  }
                  .app-card {
                      background: rgba(255,255,255,0.05);
                      border: 1px solid rgba(255,255,255,0.1);
                      border-radius: 12px;
                      padding: 20px;
                      transition: all 0.3s ease;
                  }
                  .app-card:hover {
                      transform: translateY(-5px);
                      border-color: #00d4ff;
                      box-shadow: 0 10px 30px rgba(0,212,255,0.2);
                  }
                  .app-card h3 {
                      color: #00d4ff;
                      margin-bottom: 10px;
                      display: flex;
                      align-items: center;
                      gap: 10px;
                  }
                  .app-card p {
                      color: #aaa;
                      font-size: 14px;
                      margin-bottom: 15px;
                      line-height: 1.5;
                  }
                  .app-card a {
                      display: inline-block;
                      background: #00d4ff;
                      color: #1a1a2e;
                      padding: 8px 20px;
                      border-radius: 6px;
                      text-decoration: none;
                      font-weight: bold;
                      transition: all 0.2s ease;
                  }
                  .app-card a:hover {
                      background: #00b8e6;
                      transform: scale(1.05);
                  }
                  .port {
                      background: #00d4ff33;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 12px;
                  }
                  .category {
                      font-size: 11px;
                      text-transform: uppercase;
                      letter-spacing: 1px;
                      color: #666;
                      margin-bottom: 5px;
                  }
                  .cli-tip {
                      background: rgba(0,0,0,0.3);
                      border-radius: 8px;
                      padding: 20px;
                      margin-top: 30px;
                  }
                  .cli-tip h3 { color: #00d4ff; margin-bottom: 10px; }
                  .cli-tip code {
                      background: #000;
                      padding: 10px 15px;
                      border-radius: 6px;
                      display: block;
                      margin-top: 10px;
                      color: #0f0;
                      font-family: 'Courier New', monospace;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Ethical Hacking Lab</h1>
                  <p class="subtitle">Practice security testing in a safe environment</p>

                  <div class="warning">
                      <strong>WARNING:</strong> These applications are intentionally vulnerable.
                      Use only in isolated lab environments. Never expose to the internet.
                  </div>

                  <div class="apps-grid">
                      <div class="app-card">
                          <div class="category">Web Application Security</div>
                          <h3>Juice Shop <span class="port">:3000</span></h3>
                          <p>OWASP's modern, sophisticated web application with 100+ hacking challenges covering the entire OWASP Top 10.</p>
                          <a href="http://localhost:3000" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">Web Application Security</div>
                          <h3>DVWA <span class="port">:4280</span></h3>
                          <p>Damn Vulnerable Web Application - Classic PHP/MySQL web app for practicing common vulnerabilities with adjustable difficulty.</p>
                          <a href="http://localhost:4280" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">Interactive Learning</div>
                          <h3>WebGoat <span class="port">:8080</span></h3>
                          <p>Interactive security lessons teaching web application security flaws with guided exercises.</p>
                          <a href="http://localhost:8080/WebGoat" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">API Security</div>
                          <h3>VAmPI <span class="port">:5000</span></h3>
                          <p>Vulnerable REST API demonstrating OWASP API Security Top 10 vulnerabilities.</p>
                          <a href="http://localhost:5000" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">Secrets Management</div>
                          <h3>WrongSecrets <span class="port">:8081</span></h3>
                          <p>OWASP project focused on secrets management pitfalls - find hidden secrets in various locations.</p>
                          <a href="http://localhost:8081" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">JavaScript Security</div>
                          <h3>Musashi-js <span class="port">:8082</span></h3>
                          <p>JavaScript-focused security challenges from the SamuraiWTF project.</p>
                          <a href="http://localhost:8082" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">Financial Security</div>
                          <h3>Vuln-Bank <span class="port">:5001</span></h3>
                          <p>Vulnerable banking application demonstrating common financial app security flaws.</p>
                          <a href="http://localhost:5001" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">Guided Tutorials</div>
                          <h3>Security Shepherd <span class="port">:8083</span></h3>
                          <p>OWASP Security Shepherd - Web and mobile application security training platform with progressive lessons.</p>
                          <a href="http://localhost:8083" target="_blank">Launch App</a>
                      </div>

                      <div class="app-card">
                          <div class="category">Node.js Security</div>
                          <h3>NodeGoat <span class="port">:4000</span></h3>
                          <p>Node.js web application demonstrating OWASP Top 10 vulnerabilities with fixes tutorial.</p>
                          <a href="http://localhost:4000" target="_blank">Launch App</a>
                      </div>
                  </div>

                  <div class="cli-tip">
                      <h3>Command Line Management</h3>
                      <p>Use the <strong>vuln-apps</strong> command to manage all applications:</p>
                      <code>vuln-apps status    # Show all apps and their URLs
          vuln-apps start     # Start all apps
          vuln-apps stop      # Stop all apps
          vuln-apps list      # List available apps</code>
                  </div>
              </div>

              <script>
                  // Replace localhost with actual IP for remote access
                  const host = window.location.hostname;
                  if (host !== 'localhost' && host !== '127.0.0.1') {
                      document.querySelectorAll('a[href*="localhost"]').forEach(link => {
                          link.href = link.href.replace('localhost', host);
                      });
                  }
              </script>
          </body>
          </html>

    - name: Configure nginx to serve landing page
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/vuln-apps
        mode: "0644"
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              root /var/www/html;
              index index.html;

              server_name _;

              location / {
                  try_files $uri $uri/ =404;
              }
          }

    - name: Enable vuln-apps nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/vuln-apps
        dest: /etc/nginx/sites-enabled/vuln-apps
        state: link

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      ignore_errors: yes

    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted
        enabled: yes

    # ===========================================
    # Final Status Message
    # ===========================================
    - name: Display completion message
      ansible.builtin.debug:
        msg: |

          ============================================
          Vulnerable Applications Deployed Successfully!
          ============================================

          Landing Page: http://{{ ansible_default_ipv4.address | default('localhost') }}

          Applications:
            - Juice Shop:        http://{{ ansible_default_ipv4.address | default('localhost') }}:3000
            - DVWA:              http://{{ ansible_default_ipv4.address | default('localhost') }}:4280
            - WebGoat:           http://{{ ansible_default_ipv4.address | default('localhost') }}:8080/WebGoat
            - VAmPI:             http://{{ ansible_default_ipv4.address | default('localhost') }}:5000
            - WrongSecrets:      http://{{ ansible_default_ipv4.address | default('localhost') }}:8081
            - Musashi-js:        http://{{ ansible_default_ipv4.address | default('localhost') }}:8082
            - Vuln-Bank:         http://{{ ansible_default_ipv4.address | default('localhost') }}:5001
            - Security Shepherd: http://{{ ansible_default_ipv4.address | default('localhost') }}:8083
            - NodeGoat:          http://{{ ansible_default_ipv4.address | default('localhost') }}:4000

          Management: Run 'vuln-apps status' for current status

          WARNING: These apps are intentionally vulnerable!
          Only use in isolated lab environments.
          ============================================
