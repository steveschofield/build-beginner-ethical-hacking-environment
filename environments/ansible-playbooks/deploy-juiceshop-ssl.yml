- name: Deploy Juice Shop with SSL via nginx
  hosts: juiceshop_host
  become: yes
  vars:
    domain: "juiceshop.ss.hackme"
    project_dir: "/opt/juiceshop-ssl"
    nginx_dir: "{{ project_dir }}/nginx"
    cert_dir: "{{ project_dir }}/certs"
    compose_file: "{{ project_dir }}/docker-compose.yml"
    nginx_conf: "{{ nginx_dir }}/default.conf"

  tasks:
    - name: Install required packages
      apt:
        name:
          - openssl
        state: present
        update_cache: yes

    - name: Stop old containers
      command: docker stop {{ item }}
      loop:
        - juiceshop-nginx
        - juiceshop
      ignore_errors: yes

    - name: Remove old containers
      command: docker rm {{ item }}
      loop:
        - juiceshop-nginx
        - juiceshop
      ignore_errors: yes

    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ nginx_dir }}"
        - "{{ cert_dir }}"

    - name: Remove default.conf if it's a directory
      file:
        path: "{{ nginx_conf }}"
        state: absent
      when: ansible_check_mode == false

    - name: Check if SSL certificate exists
      stat:
        path: "{{ cert_dir }}/juiceshop.crt"
      register: cert_exists

    - name: Generate self-signed SSL certificate
      command: >
        openssl req -x509 -nodes -newkey rsa:2048
        -keyout {{ cert_dir }}/juiceshop.key
        -out {{ cert_dir }}/juiceshop.crt
        -days 365
        -subj "/CN={{ domain }}"
        -addext "subjectAltName=DNS:{{ domain }},DNS:localhost,IP:127.0.0.1"
      when: not cert_exists.stat.exists

    - name: Create nginx configuration
      copy:
        content: |
          server {
            listen 443 ssl;
            server_name {{ domain }};
            ssl_certificate     /etc/nginx/certs/juiceshop.crt;
            ssl_certificate_key /etc/nginx/certs/juiceshop.key;
            location / {
              proxy_pass http://juiceshop:3000;
              proxy_set_header Host $host;
              proxy_set_header X-Forwarded-Proto https;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }
          }
          server {
            listen 80;
            server_name {{ domain }};
            return 301 https://$host$request_uri;
          }
        dest: "{{ nginx_conf }}"
        mode: '0644'

    - name: Create docker-compose.yml
      copy:
        content: |
          services:
            juiceshop:
              image: bkimminich/juice-shop:latest
              container_name: juiceshop
              restart: unless-stopped
              expose:
                - "3000"
            nginx:
              image: nginx:alpine
              container_name: juiceshop-nginx
              restart: unless-stopped
              depends_on:
                - juiceshop
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
                - ./certs:/etc/nginx/certs:ro
        dest: "{{ compose_file }}"
        mode: '0644'

    - name: Add domain to /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^.*{{ domain }}$'
        line: "127.0.0.1 {{ domain }}"
        state: present

    - name: Start docker compose stack
      command: docker compose up -d
      args:
        chdir: "{{ project_dir }}"

    - name: Wait for containers to be healthy
      pause:
        seconds: 10

    - name: Verify containers are running
      command: docker ps --filter name=juiceshop
      register: docker_ps_output

    - name: Display running containers
      debug:
        var: docker_ps_output.stdout_lines

    - name: Display access information
      debug:
        msg:
          - "Juice Shop SSL deployment complete!"
          - "HTTPS URL: https://{{ domain }}"
          - "Note: Accept the browser certificate warning (self-signed cert)"