---
- name: Run theee playbook tasks on the localhost from the /vagrant folder
  hosts: 127.0.0.1
  connection: local
  become: yes
  gather_facts: false
  vars:
    groupname: 52pickup
    username: 52pickup
    ansible_python_interpreter: /usr/bin/python3

  pre_tasks:
    - name: Ensure Python 3 and apt dependencies are present (minimal Debian/Ubuntu)
      raw: |
        set -e
        export DEBIAN_FRONTEND=noninteractive
        # Recover from interrupted apt/dpkg runs before any install/update.
        dpkg --configure -a || true
        apt-get install -f -y || true
        apt-get update -y
        apt-get install -y sudo software-properties-common
        if grep -qi ubuntu /etc/os-release; then
          add-apt-repository -y ppa:deadsnakes/ppa || true
        fi
        apt-get update -y
        apt-get install -y python3 python3-venv python3-apt
      args:
        warn: false

    - name: Gather facts
      ansible.builtin.setup:

  tasks:
    - name: Abort when not on Debian/Ubuntu
      ansible.builtin.fail:
        msg: "This playbook is intended for Debian/Ubuntu hosts because it relies on apt."
      when: ansible_os_family | lower != "debian"

    - name: Create group
      ansible.builtin.group:
        name: "{{ groupname }}"
        state: present

    - name: Ensure sudo group exists
      ansible.builtin.group:
        name: sudo
        state: present

    - name: Ensure user is present
      ansible.builtin.user:
        name: "{{ username }}"
        groups: "{{ groupname }},sudo"
        password: "$1$XF.06J/n$A1G6zX5AF33pQQOTcH0Ix."
        shell: /bin/bash
        state: present

    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - software-properties-common
          - gnupg
        state: present
        update_cache: yes

    - name: Install additional packages
      ansible.builtin.apt:
        name:
          - nginx
          - vim
          - unzip
          - php-fpm
          - nano
          - python3
          - python3-pip
          - python-is-python3
          - default-jre
          - net-tools
          - make
          - build-essential
          - libssl-dev
          - zlib1g-dev
          - libbz2-dev
          - libreadline-dev
          - libsqlite3-dev
          - wget
          - curl
          - llvm
          - libncurses5-dev
          - libncursesw5-dev
          - xz-utils
          - tk-dev
          - libffi-dev
          - liblzma-dev
          - python3-openssl
          - iputils-ping
          - iputils-tracepath
          - iputils-arping
          - dnsutils
          - git
        state: present

    - name: Install aptitude
      apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: Add Pyenv
      shell: |
        cd "/home/{{ username }}"
        curl https://pyenv.run | bash
      args:
        creates: "/home/{{ username }}/.pyenv"
      become: yes
      become_user: "{{ username }}"

    - name: Configure environment variables for pyenv
      blockinfile:
        path: "/home/{{ username }}/.profile"
        block: |
          export PYENV_ROOT="$HOME/.pyenv"
          [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
          command -v pyenv >/dev/null 2>&1 && eval "$(pyenv init --path)"
          command -v pyenv >/dev/null 2>&1 && eval "$(pyenv virtualenv-init -)"
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes
      become: yes
      become_user: "{{ username }}"

    - name: Apply profile changes (best-effort)
      shell: source "/home/{{ username }}/.profile"
      args:
        executable: /bin/bash
      become: yes
      become_user: "{{ username }}"
      failed_when: false

    - name: Ensure .ssh directory exists for user
      ansible.builtin.file:
        path: "/home/{{ username }}/.ssh"
        state: directory
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0700"

    - name: Ensure authorized_keys file exists for user
      ansible.builtin.file:
        path: "/home/{{ username }}/.ssh/authorized_keys"
        state: touch
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0600"
