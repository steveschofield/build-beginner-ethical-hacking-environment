---
- name: Run theee playbook tasks on the localhost from the /vagrant folder
  hosts: 127.0.0.1
  connection: local
  become: yes
  gather_facts: false
  vars:
    groupname: 52pickup
    username: 52pickup

  pre_tasks:
    - name: Ensure Python and apt dependencies are present (minimal Ubuntu)
      raw: apt-get update -y && apt-get install -y python3 python3-apt sudo
      args:
        warn: false

    - name: Gather facts
      ansible.builtin.setup:

  tasks:
    - name: Abort when not on Debian/Ubuntu
      ansible.builtin.fail:
        msg: "This playbook is intended for Debian/Ubuntu hosts because it relies on apt."
      when: ansible_os_family | lower != "debian"

    - name: Create group
      ansible.builtin.group:
        name: "{{ groupname }}"
        state: present

    - name: Ensure sudo group exists
      ansible.builtin.group:
        name: sudo
        state: present

    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - software-properties-common
          - gnupg
        state: present
        update_cache: yes

    - name: Enable universe repository (needed for security tools)
      ansible.builtin.command:
        argv:
          - add-apt-repository
          - --yes
          - universe
      changed_when: true

    - name: Update apt cache after enabling universe
      ansible.builtin.apt:
        update_cache: yes

    - name: Install additional packages
      ansible.builtin.apt:
        name:
          - nginx
          - vim
          - unzip
          - php-fpm
          - nano
          - python3
          - python3-pip
          - python-is-python3
          - net-tools
          - make
          - build-essential
          - libssl-dev
          - zlib1g-dev
          - libbz2-dev
          - libreadline-dev
          - libsqlite3-dev
          - wget
          - curl
          - llvm
          - libncurses5-dev
          - libncursesw5-dev
          - xz-utils
          - tk-dev
          - libffi-dev
          - liblzma-dev
          - python3-openssl
          - iputils-ping
          - iputils-tracepath
          - iputils-arping
          - dnsutils
        state: present

    - name: Install OpenJDK 17 JRE
      ansible.builtin.apt:
        name: openjdk-17-jre
        state: present
      register: jdk17_install
      failed_when: false

    - name: Fall back to OpenJDK 11 JRE if 17 not available
      ansible.builtin.apt:
        name: openjdk-11-jre
        state: present
      when: jdk17_install is failed

    - name: Install aptitude
      apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: Add Pyenv
      shell: |
        cd "/home/{{ username }}"
        curl https://pyenv.run | bash
      args:
        creates: "/home/{{ username }}/.pyenv"
      become: yes
      become_user: "{{ username }}"

    - name: Configure environment variables for pyenv
      blockinfile:
        path: "/home/{{ username }}/.profile"
        block: |
          export PYENV_ROOT="$HOME/.pyenv"
          [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
          command -v pyenv >/dev/null 2>&1 && eval "$(pyenv init --path)"
          command -v pyenv >/dev/null 2>&1 && eval "$(pyenv virtualenv-init -)"
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes
      become: yes
      become_user: "{{ username }}"

    - name: Apply profile changes (best-effort)
      shell: source "/home/{{ username }}/.profile"
      args:
        executable: /bin/bash
      become: yes
      become_user: "{{ username }}"
      failed_when: false

    - name: Ensure .ssh directory exists for user
      ansible.builtin.file:
        path: "/home/{{ username }}/.ssh"
        state: directory
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0700"

    - name: Ensure authorized_keys file exists for user
      ansible.builtin.file:
        path: "/home/{{ username }}/.ssh/authorized_keys"
        state: touch
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0600"
